[参考地址](https://juejin.cn/post/6844904021308735502)

## 目录
- [题外话——浏览器简介](#browser)
- [简单流程](#above)
- [输入URL到渲染的过程——网络过程](#network)
- [输入URL到渲染的过程——解析过程](#analyse)
- [输入URL到渲染的过程——渲染过程](#render)
---
## <span id="browser">**题外话-浏览器简介**</span>

&emsp;&emsp;浏览器主要组成部分如下：

- **用户界面**：包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面；
- **浏览器引擎**：在用户界面和呈现引擎之间传送指令；
- **呈现引擎**：负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上；
- **网络**：用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现；
- **用户界面后端**：用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法；
- **JavaScript解释器**：用于解析和执行 JavaScript 代码；
- **数据存储**：这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。

![avatar](./页面渲染/browser.png)

---
## <span id="above">**简单流程**</span>

&emsp;&emsp;先给出一个简单的流程，后面有更加详细的描述内容：

### **网络部分**
1. 构建请求行
2. 查找强缓存，有则使用无则下一步
3. DNS查找，查找过程：浏览器自身的DNS缓存-> OS自身DNS缓存-> 读取host文件->本地域服务器->权限域名服务器->根域名服务器
4. 建立 TCP 连接
    1. 三次握手
    2. 四次挥手
5. 服务端返回数据
    1. 是否断开TCP连接要看Connection字段是否为Keep-Alive

### **解析部分**

6. 构建DOM树
    1. 标记化算法
    2. 建树算法
7. 样式计算
    1. 格式化样式表
    2. 标准化样式表
    3. 计算每个点的具体位置
8. 生成布局树 Layuot Tree
    1. 遍历DOM树节点
    2. 计算布局树节点的坐标位置

### **渲染部分**

9. 生成图层树 Layer Tree
10. 生成绘制列表
11. 生成图块并栅格化
12. 显示器显示内容




---
## <span id="network">**输入URL到渲染的过程——网络过程**</span>

### **网络请求的部分**

#### **1、构建请求**

&emsp;&emsp;浏览器构建请求行
```
//  请求方式为GET，路径为根路径，HTTP协议版本为1.1
GET / HTTP/1.1
```

#### **2、查找强缓存**

&emsp;&emsp;先检查强缓存，如果命中直接使用，不中则进入下一步。**注意：强缓存不需要发送HTTP请求，因此这里就可以进行判定。**

#### **3、DNS解析**

&emsp;&emsp;一般都是输入`域名`，而数据包是通过`IP地址`传给对方，因此需要得到`域名`对应的`IP地址`。**DNS系统**将域名和IP一一映射，得到具体的IP的过程就是DNS解析。

&emsp;&emsp;浏览器提供了**DNS数据缓存功能**，当一个域名解析过，就将解析结果缓存下来，下次可直接使用。

&emsp;&emsp;如果不指定端口，默认采用对应IP的80端口。

#### **4、建立TCP连接**

&emsp;&emsp;Chrome在同一域名下要求同时最多只能由6个TCP连接，超过6个后剩下的将需要等待。

&emsp;&emsp;不需要等待的将建立TCP连接，分为如下三个阶段：
- 通过**三次握手**建立客户端和服务器之间的连接；
- 进行数据传输。接收方接收到数据包后必须要向发送方`确认`，发送方未收到`确认`会判定为数据包丢失，于是重新传输。传输过程可以将大数据包拆成一个个小包，接收方按照顺序再组装；
- 通过**四次挥手**来断开连接。

#### **5、发送HTTP请求**

&emsp;&emsp;当TCP连接建立后，浏览器开始和服务器通信，开始发送HTTP请求。**发送的HTTP请求有三个部分：请求行、请求头和请求体。**

&emsp;&emsp;**请求行**可以参看第一步，由**请求方法、请求URL和HTTP版本组成**；

&emsp;&emsp;**请求头**包含了如下示例属性：
```
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cache-Control: no-cache
Connection: keep-alive
Cookie: /* 省略cookie信息 */
Host: www.baidu.com
Pragma: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1
```

&emsp;&emsp;**请求体**只有在POST请求中才会有。

### **网络响应**

&emsp;&emsp;HTTP请求发送到服务器，服务器经过相应处理后要把数据返回给浏览器。**网络响应有三个部分：响应行、响应头和响应体。**

&emsp;&emsp;响应行示例如下，由HTTP协议版本、状态码和状态描述组成：
```
HTTP/1.1 200 OK
```

&emsp;&emsp;响应头包含了服务器及其返回数据的一些信息，服务器生成数据时间、返回的数据类型以及即将写入Cookie的信息。示例如下：
```
Cache-Control: no-cache
Connection: keep-alive
Content-Encoding: gzip
Content-Type: text/html;charset=utf-8
Date: Wed, 04 Dec 2019 12:29:13 GMT
Server: apache
Set-Cookie: rsv_i=f9a0SIItKqzv7kqgAAgphbGyRts3RwTg%2FLyU3Y5Eh5LwyfOOrAsvdezbay0QqkDqFZ0DfQXby4wXKT8Au8O7ZT9UuMsBq2k; path=/; domain=.baidu.com
```
&emsp;&emsp;响应完成后，要判断`Connection`字段，假如请求头或者响应头中包含**Connection: Keep-Alive**，表示建立持久连接，TCP连接将一直保持，之后请求同一站点的资源会复用该连接；否则断开TCP连接，结束请求——响应的流程。

### **总结**

![avatar](./页面渲染/network.png)

---
## <span id="analyse">**输入URL到渲染的过程——解析过程**</span>

&emsp;&emsp;完成网络请求和响应，如果响应头中`Content-Type`的值是`text/heml`，那么之后就是浏览器的解析和渲染工作。

&emsp;&emsp;首先看看解析部分，主要有如下步骤：
- 构建DOM树；
- 样式计算；
- 生成布局树（Layout Tree）

### **构建DOM树**

&emsp;&emsp;浏览器无法直接理解HTML字符串，因此将其转换为方便操作的数据结构，即DOM树。DOM树本质上是一个以documnet为根节点的多叉树。


### **样式计算**




### **生成布局树**



### **总结**
![avatar](./页面渲染/analyse.png)



---
## <span id="render">**输入URL到渲染的过程——渲染过程**</span>

&emsp;&emsp;渲染的过程主要分为如下步骤：
- 建立图层树（Layer Tree）
- 生成绘制列表
- 生成图块并栅格化
- 显示器显示内容


### **建图层树**


### **生成绘制列表**


### **生成图块并栅格化**


### **显示器显示内容**


### **总结**
![avatar](./页面渲染/render.png)
